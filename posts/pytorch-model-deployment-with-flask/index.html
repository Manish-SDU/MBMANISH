<!DOCTYPE html><html lang="en">
<!-- Mirrored from www.python-engineer.com/posts/pytorch-model-deployment-with-flask/ by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Sep 2022 12:01:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head><meta charset="UTF-8"/><meta name="og:site_name" content="Python Engineer"/><link rel="canonical" href="https://python-engineer.com/posts/pytorch-model-deployment-with-flask"/><meta name="twitter:url" content="https://python-engineer.com/posts/pytorch-model-deployment-with-flask"/><meta name="og:url" content="https://python-engineer.com/posts/pytorch-model-deployment-with-flask"/><title>Create &amp; Deploy A Deep Learning App - PyTorch Model Deployment With Flask &amp; Heroku | Python Engineer</title><meta name="twitter:title" content="Create & Deploy A Deep Learning App - PyTorch Model Deployment With Flask & Heroku | Python Engineer"/><meta name="og:title" content="Create & Deploy A Deep Learning App - PyTorch Model Deployment With Flask & Heroku | Python Engineer"/><meta name="description" content="Create and Deploy your first Deep Learning app! In this PyTorch tutorial we learn how to deploy our PyTorch model with Flask and Heroku."/><meta name="twitter:description" content="Create and Deploy your first Deep Learning app! In this PyTorch tutorial we learn how to deploy our PyTorch model with Flask and Heroku."/><meta name="og:description" content="Create and Deploy your first Deep Learning app! In this PyTorch tutorial we learn how to deploy our PyTorch model with Flask and Heroku."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="../../styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="../../images/favicon.png" type="image/png"/><link rel="alternate" href="../../feed.rss" type="application/rss+xml" title="Subscribe to Python Engineer"/><meta name="twitter:image" content="../../images/icon.png"/><meta name="og:image" content="../../images/icon.png"/><script async defer data-domain="python-engineer.com" src="../../../plausible.io/js/plausible.js"></script></head><body class="item"><header><div class="header-promotion"><p><div class="wrapper"><p><a href="https://pythonengineer.pallet.com/" target="_blank">üêç Find Python and ML Jobs! üêç</a></p></div></p></div><div class="wrapper"><nav><ul><li class="selected"><a href="../index.html">POSTS</a></li><li><a href="../../courses/index.html">COURSES</a></li><li><a href="../../about/index.html">ABOUT</a></li></ul></nav><a href="../../index.html"><div class="hero-container"><img class="header-image-small" src="../../images/pat_face_bg.webp" alt="Patrick Loeber"/><div class="hero-text-container justify-center"><p>Become a</p><h1 class="colorized-text ">Python Engineer</h1><p class="mobile-hide">Come and learn about</p><ul class="mobile-hide"><li><a class="variant-a" href="../../tags/python/index.html">Python</a></li><li id="regular-li">and</li><li><a class="variant-b" href="../../tags/machine-learning/index.html">Machine Learning</a></li></ul></div></div></a></div></header><article class="page wrapper post-page"><h1 class="blog-header">Create &amp; Deploy A Deep Learning App - PyTorch Model Deployment With Flask &amp; Heroku</h1><div class="metadata"><ul class="tags"><li class="variant-c"><a href="../../tags/pytorch/index.html">PyTorch</a></li><li class="variant-c"><a href="../../tags/deep-learning/index.html">Deep Learning</a></li><li class="variant-g"><a href="../../tags/web/index.html">Web</a></li></ul><span class="post-date">05 Aug 2020, by </span><a class="author-link-post" href="../../authors/patrick/index.html">Patrick Loeber</a></div><div class="video-player"><iframe frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="true" src="https://www.youtube-nocookie.com/embed/bA7-DEtYCNM"></iframe></div><div class="content page-content m-top"><p>Create and Deploy your first Deep Learning app! In this PyTorch tutorial we learn how to deploy our PyTorch model with Flask and Heroku. We create a simple Flask app with a REST API that returns the result as json data, and then we deploy it to Heroku. As an example PytTorch app we do digit classification, and at the end we can draw our own digits and then predict it with our live running app.</p><h3>Technology we will be using</h3><ul><li><a href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a></li><li><a href="https://www.heroku.com/">Heroku</a></li><li><a href="https://pytorch.org/">PyTorch</a></li></ul><h3>Setup</h3><p>Create project with virtual environment (Commands might slightly differ on Windows).</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>mkdir pytorch-deploy
<span class="gp">$ </span><span class="nb">cd</span> pytorch-deploy
<span class="gp">$ </span>python3 -m venv venv
</div></code></pre><p>Activate it</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>. venv/bin/activate
</div></code></pre><p>or on Windows</p><pre><code><div class="highlight"><span></span><span class="go">venv\Scripts\activate</span>
</div></code></pre><p>Install Flask and PyTorch</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>pip install Flask
<span class="gp">$ </span>pip install torch torchvision
</div></code></pre><h3>Create the app</h3><p>Create a new directory <em>app</em>, and then inside this the <em>main.py</em> file and insert:</p><pre><code><div class="highlight"><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">predict</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;test_result&#39;</span><span class="p">})</span>
</div></code></pre><p>We only need one endpoint <code>@app.route('/predict')</code>. Here we want receive an image, predict it with our PyTorch model, and then return the result as json data. For now we only return a dummy json data with Flask's <code>jsonify</code> method.</p><h3>Run and test the app</h3><p>Run</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span><span class="nb">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span>app/main.py
<span class="gp">$ </span><span class="nb">export</span> <span class="nv">FLASK_ENV</span><span class="o">=</span>development
<span class="gp">$ </span>flask run
</div></code></pre><p>Create a test folder <em>test</em> and inside a <em>test.py</em> file and insert:</p><pre><code><div class="highlight"><span></span><span class="kn">import</span> <span class="nn">requests</span> 

<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;http://localhost:5000/predict&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</div></code></pre><p>In a second terminal run your <em>test.py</em> file (You may need to install requests: <code>pip install requests</code>). If everything is working correctly, this should print the dummy json data <code>{'test': 'test_result'}</code>.</p><h3>Train and save your model.</h3><p>Grab the code from my PyTorch course <a href="../../courses/pytorchbeginner/13-feedforward-neural-network/index.html">here</a>. This is a simple feed forward neural net that is trained on the MNIST dataset and used for digit classifications. The only modification we do is to add another dataset transformation because I want to demonstrate that we need this same transformation in our app, too. So in the beginning use this transformation and apply it to the dataset:</p><pre><code><div class="highlight"><span></span><span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),(</span><span class="mf">0.3081</span><span class="p">,))])</span>

<span class="c1"># MNIST dataset </span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> 
                                           <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                           <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>  
                                           <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span> 
                                          <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                          <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
</div></code></pre><p>This is just a normalization with the global mean and standard deviation of the MNIST dataset.</p><p>Now at the very end of the file, insert this line to save the model after training.</p><pre><code><div class="highlight"><span></span><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">&quot;mnist_ffn.pth&quot;</span><span class="p">)</span>
</div></code></pre><p>Then run this file. This should train the model, print a high accuracy, and save the model to our specified file. Grab this file and copy it into the <em>app</em> folder.</p><h3>Create PyTorch utility functions</h3><p>Create a new file <em>torch_utils.py</em> inside the <em>app</em> folder. Here we want to do three things:</p><ul><li>Load the model</li><li>Preprocess the image and convert it to a torch tensor</li><li>Do the prediction</li></ul><h4>Load the model</h4><p>To learn about saving and loading, you can also have a look at my PyTorch course <a href="../../courses/pytorchbeginner/17-saving-and-loading/index.html">here</a>. We create the same model as in our original file, load the state dictionary, and set it to <code>eval</code> mode. We only use the CPU version here, otherwise our package is too large for Heroku. So if you trained on the GPU, make sure to load it correctly. You'll find the code in the saving/loading tutorial, too. You can remove all <code>.to(device)</code> calls from the code. No worries, the CPU is fine and fast enough for model inference in this application.</p><pre><code><div class="highlight"><span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">torch</span> 
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span> 
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span> 
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="k">class</span> <span class="nc">NeuralNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NeuralNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>  
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="c1"># no activation and no softmax at the end</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="n">input_size</span> <span class="o">=</span> <span class="mi">784</span> <span class="c1"># 28x28</span>
<span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">500</span> 
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">NeuralNet</span><span class="p">(</span><span class="n">input_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;mnist_ffn.pth&quot;</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">PATH</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</div></code></pre><h4>Load and transform the image</h4><p>Here we want to make sure our tensor has the same properties as in the MNIST dataset. So we apply the same transformations as in the original file. Additionally we want to resize our image to (28,28), and convert it to a grayscale image. Add this function to the <em>torch_utils.py</em> file:</p><pre><code><div class="highlight"><span></span><span class="k">def</span> <span class="nf">transform_image</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">):</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">Grayscale</span><span class="p">(</span><span class="n">num_output_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)),</span>
                                    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                                    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),(</span><span class="mf">0.3081</span><span class="p">,))])</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</div></code></pre><h4>Prediction</h4><p>Now we use the same code as in the original file to predict the image and return the prediction in a new helper function:</p><pre><code><div class="highlight"><span></span><span class="k">def</span> <span class="nf">get_prediction</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">):</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">image_tensor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="c1"># max returns (value ,index)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predicted</span>
</div></code></pre><h3>Put everything together</h3><p>In the <em>main.py</em> file, import these helper function and put everything together in the <code>predict</code>method. Additionally, we also include some error checking and only allow certain files:</p><pre><code><div class="highlight"><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="kn">from</span> <span class="nn">torch_utils</span> <span class="kn">import</span> <span class="n">transform_image</span><span class="p">,</span> <span class="n">get_prediction</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">}</span>
<span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># xxx.png</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">predict</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;no file&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;format not supported&#39;</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">tensor</span> <span class="o">=</span> <span class="n">transform_image</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s1">&#39;class_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">item</span><span class="p">())}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;error during prediction&#39;</span><span class="p">})</span>
</div></code></pre><p>Note that for this dataset <code>prediction</code> and <code>class_name</code> are the same. Normally we would have to do a mapping from the index to the actual class name here.</p><h3>Test the model</h3><p>Now grab some example images or draw your own with a simple paint program. In my case I used <em>Paintbrush</em> on the Mac, created a new image with size 100x100, filled the background with black, and draw digits with white color. Save it a <em>png</em> or <em>jpg</em>, and copy the files into the <em>test</em> folder. Now include this image into your post request, for example with an image called <em>eight.png</em>:</p><pre><code><div class="highlight"><span></span><span class="kn">import</span> <span class="nn">requests</span> 

<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;http://localhost:5000/predict&quot;</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eight.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</div></code></pre><p>This should print <code>{'prediction': 8, 'class_name': 8}</code>. Congratulations! You now have a running PyTorch web app! As a last step we deploy it to Heroku</p><h3>Deploy to Heroku</h3><p>For production we want to have a proper web server, so we install <em>gunicorn</em>:</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>pip install gunicorn
</div></code></pre><p>All the following files should be added to the base directory. First, create a <em>wsgi.py</em> file and insert this line</p><pre><code><div class="highlight"><span></span><span class="kn">from</span> <span class="nn">app.main</span> <span class="kn">import</span> <span class="n">app</span>
</div></code></pre><p>Create a <em>Procfile</em> and insert this:</p><pre><code><div class="highlight"><span></span><span class="go">web: gunicorn wsgi:app</span>
</div></code></pre><p>Modify path names to take the <em>app</em> package as base:</p><pre><code><div class="highlight"><span></span><span class="c1"># in the main.py file:</span>
<span class="kn">from</span> <span class="nn">app.torch_utils</span> <span class="kn">import</span> <span class="n">get_prediction</span><span class="p">,</span> <span class="n">transform_image</span>

<span class="c1"># in the torch_utils.py file</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;app/mnist_ffn.pth&quot;</span>
</div></code></pre><p>Create a <em>runtime.txt</em> and insert the Python version you are using:</p><pre><code><div class="highlight"><span></span><span class="go">python-3.8.3</span>
</div></code></pre><p>Make sure you are in the root folder of your package again. Now add all the packages to the <em>requirements.txt</em> file using <code>pip freeze</code>:</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>pip freeze &gt; requirements.txt
</div></code></pre><p>Since we only can use the CPU version, modify the file like this to use PyTorch's CPU-only version. The command for CPU-only version can be taken from the PyTorch installation guide <a href="https://pytorch.org/get-started/locally/">here</a>. Select Linux, pip, and CUDA None. The download command may be added as first line in your <em>requirements.txt</em> file:</p><pre><code><div class="highlight"><span></span><span class="go">-f https://download.pytorch.org/whl/torch_stable.html</span>
<span class="go">torch==1.6.0+cpu</span>
<span class="go">torchvision==0.7.0+cpu</span>
</div></code></pre><p>Add a <em>.gitignore</em>. You can take this version for Python from <a href="https://github.com/github/gitignore/blob/master/Python.gitignore">GitHub</a>. Also add the testing folder, so the file may have this as first lines:</p><pre><code><div class="highlight"><span></span><span class="go">test/</span>

<span class="gp"># </span>Byte-compiled / optimized / DLL files
<span class="go">__pycache__/</span>
<span class="go">*.py[cod]</span>
<span class="go">*$py.class</span>
<span class="go">...</span>
</div></code></pre><p>Create a Heroku app. For this you need to have the Heroku CLI installed. You can get it <a href="https://devcenter.heroku.com/articles/heroku-cli">here</a>. Login and then create a new app with the name you want:</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>heroku login -i
<span class="gp">$ </span>heroku create your-app-name
</div></code></pre><p>Test your app locally:</p><pre><code><div class="highlight"><span></span><span class="gp">$ </span>heroku <span class="nb">local</span>
</div></code></pre><p>Now add a git repository, commit all the files, and push it to Heroku:</p><pre><code><div class="highlight"><span></span><span class="go">git init</span>
<span class="go">heroku git:remote -a your-app-name</span>
<span class="go">git add .</span>
<span class="go">git commit -m &quot;initial commit&quot;</span>
<span class="go">git push heroku master</span>
</div></code></pre><p>This should deploy your app to Heroku and will show you the link to your live running app. Now let's use this url in the <em>test.py</em> file like this:</p><pre><code><div class="highlight"><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://your-app-name.herokuapp.com/predict&quot;</span><span class="p">,</span>
                     <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;eight.png&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</div></code></pre><p>Congratulations! You now have a live running app with a PyTorch model that can do digit classification! Note that the first time we send a request this may take a few seconds, since Heroku has to wake up our app first if we only use the free tier.</p><p>I hope you enjoyed this tutorial!</p></div><ul class="actions"><li><a class="youtube-button" href="https://www.youtube.com/channel/UCbXgNpp0jedKWcQiULLbDTA?sub_confirmation=1" target="_blank" rel="nofollow">Subscribe</a></li><li><a class="twitter-button" href="https://twitter.com/intent/tweet?via=python_engineer&amp;text=Create%20and%20Deploy%20A%20Deep%20Learning%20App%20-%20PyTorch%20Model%20Deployment%20With%20Flask%20and%20Heroku&amp;url=https://python-engineer.com/posts/pytorch-model-deployment-with-flask" rel="nofollow" target="_blank">Share</a></li></ul><div class="affiliate-container"><div><h2>FREE VS Code / PyCharm Extensions I Use</h2><p>‚úÖ Write cleaner code with Sourcery, instant refactoring suggestions: <a href="https://sourcery.ai/?utm_source=youtube&amp;utm_campaign=pythonengineer" target="_blank">Link *</a></p><p class="affiliate-note">* This is an affiliate link. By clicking on it you will not have any additional costs, instead you will support me and my project. Thank you! üôè</p></div></div><a class="sponsor-container" href="../../newsletter/index.html" rel="nofollow"><img class="main" src="../../images/numpyhandbook.webp" alt="newsletter"/><div><h2>FREE NumPy Handbook</h2><p>Learn NumPy with this eBook! It covers code examples for all essential functions. Get it for free together with monthly Python tips and news.</p><button class="pill-button">I Want This</button></div></a><div><div><a class="section-header pad-top" href="../../courses/index.html"><h2>Check out my Courses</h2></a><ul class="item-list grid"><li><article class="post-card"><a href="../../courses/tensorflowbeginner/index.html"><img class="post-thumb" alt="Thumbnail image of the post." src="../../images/titles/tfcourse.webp"/></a><ul class="tags"><li class="variant-a"><a href="../../tags/python/index.html">Python</a></li><li class="variant-f"><a href="../../tags/tensorflow/index.html">TensorFlow</a></li><li class="variant-c"><a href="../../tags/deep-learning/index.html">Deep Learning</a></li></ul><a class="post-link" href="../../courses/tensorflowbeginner/index.html"><h1 class="description">TensorFlow 2 Beginner</h1><p>Learn all the necessary basics to get started with TensorFlow 2 and Keras.</p></a></article></li><li><article class="post-card"><a href="../../courses/pytorchbeginner/index.html"><img class="post-thumb" alt="Thumbnail image of the post." src="../../images/titles/pytorchcourse.webp"/></a><ul class="tags"><li class="variant-a"><a href="../../tags/python/index.html">Python</a></li><li class="variant-c"><a href="../../tags/pytorch/index.html">PyTorch</a></li><li class="variant-c"><a href="../../tags/deep-learning/index.html">Deep Learning</a></li></ul><a class="post-link" href="../../courses/pytorchbeginner/index.html"><h1 class="description">PyTorch Beginner</h1><p>Learn all the necessary basics to get started with this deep learning framework.</p></a></article></li><li><article class="post-card"><a href="../../courses/mlfromscratch/index.html"><img class="post-thumb" alt="Thumbnail image of the post." src="../../images/titles/mlfromscratch.webp"/></a><ul class="tags"><li class="variant-a"><a href="../../tags/python/index.html">Python</a></li><li class="variant-b"><a href="../../tags/machine-learning/index.html">Machine Learning</a></li><li class="variant-d"><a href="../../tags/numpy/index.html">numpy</a></li></ul><a class="post-link" href="../../courses/mlfromscratch/index.html"><h1 class="description">ML From Scratch</h1><p>Implement popular Machine Learning algorithms from scratch using only built-in Python modules and numpy.</p></a></article></li><li><article class="post-card"><a href="../../courses/advancedpython/index.html"><img class="post-thumb" alt="Thumbnail image of the post." src="../../images/titles/advancedpythoncourse.webp"/></a><ul class="tags"><li class="variant-a"><a href="../../tags/python/index.html">Python</a></li></ul><a class="post-link" href="../../courses/advancedpython/index.html"><h1 class="description">Advanced Python</h1><p>Advanced Python Tutorials. It covers topics like collections, decorators, generators, multithreading, logging, and much more.</p></a></article></li></ul></div></div></article><footer><div class="wrapper patreon-footer"><h1>Patreon</h1><p>Become a Patron and get exclusive content! Get access to ML From Scratch notebooks, join a private Discord channel, get priority response, and more!</p><div class="gold-patrons"><h3>Special thanks to my Gold Patreons:</h3><p>Tonja J R</p><p>Daniel And Andy</p><p>Sergei</p></div><p>And of course thanks to every other member! I really appreciate the support!</p><a href="https://www.patreon.com/patrickloeber" target="_blank">Find Out More</a></div><div class="wrapper"><p>Copyright ¬© Python Engineer 2022.</p><p>Generated using <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a>.</p><ul class="footer-links"><li><a class="youtube-button youtube-icon" href="https://www.youtube.com/channel/UCbXgNpp0jedKWcQiULLbDTA" target="_blank">YouTube</a></li><li><a class="social-button twitter-button" href="https://twitter.com/python_engineer" target="_blank">Twitter</a></li><li><a class="social-button github-button" href="https://github.com/python-engineer" target="_blank">GitHub</a></li><li><a class="social-button discord-button" href="https://discord.gg/FHMg9tKFSN" target="_blank">Discord</a></li><li><a class="footer-button" href="../../feed.rss">RSS</a></li><li><a class="footer-button" href="../../about/index.html">Contact</a></li><li><a class="footer-button" href="../../legal-notice/index.html">Legal Notice</a></li><li><a class="footer-button" href="../../privacy-policy/index.html">Privacy Policy</a></li></ul></div></footer></body>
<!-- Mirrored from www.python-engineer.com/posts/pytorch-model-deployment-with-flask/ by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Sep 2022 12:01:52 GMT -->
</html>